<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azkar Reader</title>
    <!-- Phase 6: PWA Manifest and Theme Color -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <!-- iOS PWA Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Azkar">
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="style.css">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-880D9JST3X"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-880D9JST3X');
    </script>
</head>

<body>
    <header class="navbar">
        <div class="logo">
            <i class="fa-solid fa-book-open"></i> Azkar Reader
        </div>
        <nav class="nav-links">
            <button class="book-btn active" data-book="th_athkar_assabah_walmasaa.pdf">อัซการยามเช้าและเย็น</button>
            <button class="book-btn" data-book="dua_mustajab_th.pdf">ดุอามุสตาญาบ</button>
        </nav>
        <div class="nav-controls">
            <button class="icon-btn theme-toggle" aria-label="Toggle Theme" title="สลับธีมสี">
                <i class="fa-solid fa-moon"></i>
            </button>
            <button class="icon-btn nav-toggle" aria-label="Toggle Menu">
                <i class="fa-solid fa-bars"></i>
            </button>
        </div>
    </header>

    <div class="mobile-menu">
        <button class="book-btn active" data-book="th_athkar_assabah_walmasaa.pdf">อัซการยามเช้าและเย็น</button>
        <button class="book-btn" data-book="dua_mustajab_th.pdf">ดุอามุสตาญาบ</button>
    </div>

    <!-- PDF Loading Overlay -->
    <div id="pdfLoadingOverlay"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); z-index:200; display:none; flex-direction:column; align-items:center; justify-content:center; gap:1rem;">
        <i class="fa-solid fa-book-open"
            style="font-size:2.5rem; color:#3b82f6; animation:pulse 1.5s ease-in-out infinite;"></i>
        <div style="color:white; font-size:1.1rem; font-weight:500;" id="loadingText">กำลังโหลด ดุอามุสตาญาบ...</div>
        <div style="width:260px; height:8px; background:rgba(255,255,255,0.2); border-radius:8px; overflow:hidden;">
            <div id="loadingProgressBar"
                style="width:0%; height:100%; background:linear-gradient(90deg,#3b82f6,#60a5fa); border-radius:8px; transition:width 0.3s ease;">
            </div>
        </div>
        <div style="color:rgba(255,255,255,0.7); font-size:0.85rem;" id="loadingPercent">0%</div>
    </div>

    <main class="main-content">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3><i class="fa-regular fa-bookmark"></i> เครื่องมือ</h3>
                <button class="close-sidebar-btn" id="closeSidebar"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="sidebar-content">
                <!-- Phase 4: Daily Tracking -->
                <div class="streak-card" id="streakCard">
                    <i class="fa-solid fa-fire streak-icon inactive" id="streakIcon"></i>
                    <div class="streak-info">
                        <h4>การอ่านต่อเนื่อง</h4>
                        <p id="streakText">อ่านวันนี้เพื่อเริ่มสะสม</p>
                    </div>
                    <div class="streak-count" id="streakCount">0 วัน</div>
                </div>

                <!-- Phase 7: Notifications -->
                <div class="tools-section">
                    <h4><i class="fa-regular fa-bell"></i> แจ้งเตือนอัซการ</h4>
                    <div class="notification-toggle-wrapper">
                        <span class="toggle-label">เตือนเช้าและเย็น</span>
                        <label class="switch">
                            <input type="checkbox" id="notificationToggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>

                <!-- Phase 8: Table of Contents (Smart Index) -->
                <div class="tools-section">
                    <h4><i class="fa-solid fa-list-ul"></i> สารบัญ (Table of Contents)</h4>
                    <ul id="tocList" class="bookmarks-list">
                        <li style="color:var(--text-secondary);font-size:0.85rem;padding:0.5rem;">กำลังโหลดสารบัญ...
                        </li>
                    </ul>
                </div>

                <!-- Phase 3: Bookmarks -->
                <div class="tools-section">
                    <h4>บุ๊กมาร์ก</h4>
                    <button id="addBookmarkBtn" class="primary-btn w-full"><i class="fa-solid fa-bookmark"></i>
                        คั่นหน้านี้</button>
                    <ul id="bookmarksList" class="bookmarks-list"></ul>
                </div>
                <!-- Phase 3: Notes -->
                <div class="tools-section">
                    <h4>จดบันทึก (หน้า <span id="notePageNum">1</span>)</h4>
                    <textarea id="pageNoteInput" rows="5" placeholder="พิมพ์บันทึกของคุณที่นี่..."></textarea>
                    <button id="saveNoteBtn" class="primary-btn mt-2 w-full">บันทึกเนื้อหา</button>
                    <p id="noteSaveStatus" class="status-msg"></p>

                    <!-- Phase 8: Note History -->
                    <div style="margin-top: 1.5rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                        <span class="badge" style="margin-bottom: 0.5rem; display: inline-block;">
                            <i class="fa-solid fa-clock-rotate-left"></i> ประวัติที่จดบันทึกไว้
                        </span>
                        <ul class="bookmarks-list" id="notesHistoryList" style="margin-top: 0.5rem;">
                            <li style="color:var(--text-secondary);font-size:0.85rem;padding:0.5rem;">
                                ไม่มีประวัติการจดบันทึก</li>
                        </ul>
                    </div>
                </div>
            </div>
        </aside>

        <section class="reader-area" id="readerArea">
            <div class="placeholder" id="placeholder">
                <i class="fa-solid fa-spinner fa-spin empty-icon" style="color: var(--accent);"></i>
                <h2>กำลังโหลดหนังสือ...</h2>
                <p>โปรดรอสักครู่</p>
            </div>

            <div class="pdf-container" id="pdfContainer" style="display: none;">
                <!-- Toolbar for PDF -->
                <div class="pdf-toolbar">
                    <button id="prevPage" class="icon-btn" title="หน้าก่อนหน้า"><i
                            class="fa-solid fa-chevron-left"></i></button>
                    <span class="page-info">
                        หน้า <select id="pageNumSelect" class="page-select" aria-label="เลือกหน้า"></select>
                        / <span id="pageCount">-</span>
                    </span>
                    <button id="nextPage" class="icon-btn" title="หน้าถัดไป"><i
                            class="fa-solid fa-chevron-right"></i></button>

                    <div class="separator"></div>

                    <!-- Primary Tool -->
                    <button id="toggleSidebarBtn" class="icon-btn" title="เครื่องมือ & สารบัญ"><i
                            class="fa-solid fa-bars-staggered"></i></button>

                    <!-- More Tools Dropdown -->
                    <div class="more-tools-container">
                        <button id="moreToolsBtn" class="icon-btn" title="เครื่องมือเพิ่มเติม"><i
                                class="fa-solid fa-ellipsis-vertical"></i></button>
                        <div id="moreToolsMenu" class="more-tools-menu">
                            <button id="zoomIn" class="icon-btn" title="ขยาย (Zoom In)"><i
                                    class="fa-solid fa-magnifying-glass-plus"></i></button>
                            <button id="zoomOut" class="icon-btn" title="ย่อ (Zoom Out)"><i
                                    class="fa-solid fa-magnifying-glass-minus"></i></button>
                            <!-- Navigation Mode Toggle -->
                            <button id="navModeBtn" class="icon-btn" title="โหมดเลื่อนหน้า: เลื่อนลง"><i
                                    class="fa-solid fa-arrows-up-down"></i></button>
                            <!-- Highlighter Mode -->
                            <button id="toggleHighlightModeBtn" class="icon-btn" title="เปิด/ปิด โหมดไฮไลท์"><i
                                    class="fa-solid fa-highlighter"></i></button>
                        </div>
                    </div>
                </div>

                <!-- Phase 4 (v2): Highlight Color Picker & Tools -->
                <div id="highlightTools" class="highlight-tools fixed-palette" style="display: none;">
                    <button class="hl-color active-color" style="background: rgba(255, 255, 0, 0.6);"
                        data-color="rgba(255, 255, 0, 0.6)" title="เหลือง"></button>
                    <button class="hl-color" style="background: rgba(50, 230, 50, 0.5);"
                        data-color="rgba(50, 230, 50, 0.5)" title="เขียว"></button>
                    <button class="hl-color" style="background: rgba(50, 200, 255, 0.5);"
                        data-color="rgba(50, 200, 255, 0.5)" title="ฟ้า"></button>
                    <button class="hl-color" style="background: rgba(255, 100, 200, 0.5);"
                        data-color="rgba(255, 100, 200, 0.5)" title="ชมพู"></button>
                    <div class="separator-vertical"></div>
                    <button class="hl-color tool-btn" id="hlUndoBtn" style="background: transparent;"
                        title="เลิกทำ (Undo)">
                        <i class="fa-solid fa-rotate-left" style="color:var(--text-primary); font-size:1rem;"></i>
                    </button>
                    <!-- Removed mask mode for now to keep canvas drawing simple, or we can keep it?
                    The original user had "โหมดท่องจำ (ปิดข้อความ)", let's add an eraser instead -->
                    <button class="hl-color tool-btn" id="hlEraserBtn" style="background: transparent;"
                        data-color="eraser" title="ยางลบ">
                        <i class="fa-solid fa-eraser" style="color:var(--text-primary); font-size:1rem;"></i>
                    </button>
                    <div class="separator-vertical"></div>
                    <!-- Stroke Width Slider -->
                    <div class="stroke-width-container"
                        style="display: flex; align-items: center; gap: 0.25rem; padding: 0 0.25rem;"
                        title="ปรับขนาดเส้น">
                        <i class="fa-solid fa-pen" style="font-size: 0.7rem; color: var(--text-secondary);"></i>
                        <input type="range" id="hlWidthSlider" min="5" max="50" value="20" class="width-slider">
                        <i class="fa-solid fa-pen" style="font-size: 1.1rem; color: var(--text-secondary);"></i>
                    </div>
                    <div class="separator-vertical"></div>
                    <button class="hl-color tool-btn" id="closeHighlightModeBtn" style="background: transparent;"
                        title="ปิดโหมดไฮไลท์">
                        <i class="fa-solid fa-xmark" style="color:var(--text-primary); font-size:1.1rem;"></i>
                    </button>
                </div>

                <div class="pdf-viewer-wrapper" id="pdfViewerWrapper">
                    <div id="pdfPageContainer" class="pdf-page-container">
                        <!-- Phase 2: PDF Rendering -->
                        <canvas id="pdfCanvas"></canvas>
                        <!-- Phase 4 (v2): Highlight Drawing Canvas -->
                        <canvas id="highlightLayer" class="highlightLayer"></canvas>
                        <!-- Phase 4: Text Layer for selection -->
                        <div id="textLayer" class="textLayer"></div>
                    </div>
                </div>
            </div>
        </section>
        <!-- Phase 3: Smart Tasbih -->
        <div class="tasbih-container">
            <button class="tasbih-btn" id="tasbihBtn" aria-label="Tasbih Counter">
                <svg class="tasbih-ring" width="64" height="64" viewBox="0 0 64 64">
                    <circle class="tasbih-ring-bg" cx="32" cy="32" r="30" fill="none" stroke="rgba(255,255,255,0.2)"
                        stroke-width="4"></circle>
                    <circle class="tasbih-ring-progress" id="tasbihRingProgress" cx="32" cy="32" r="30" fill="none"
                        stroke="var(--gold)" stroke-width="4" stroke-linecap="round"></circle>
                </svg>
                <div class="tasbih-content">
                    <span class="tasbih-count" id="tasbihCount">0</span>
                    <span class="tasbih-icon"><i class="fa-solid fa-hand-holding-heart"></i></span>
                </div>
            </button>
            <button class="tasbih-reset" id="tasbihReset" title="รีเซ็ตตัวนับ">รีเซ็ต</button>
        </div>
    </main>

    <!-- Onboarding Tooltip -->
    <div id="onboardingTooltip" class="onboarding-tooltip" style="display: none;">
        <div class="tooltip-content">
            <i class="fa-solid fa-arrows-left-right"></i>
            <p>ปัดซ้าย-ขวา เพื่อเปลี่ยนหน้า</p>
            <button id="closeTooltipBtn" class="primary-btn">เข้าใจแล้ว</button>
        </div>
    </div>

    <!-- Phase 2: PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
    <script src="script.js"></script>
</body>

</html>